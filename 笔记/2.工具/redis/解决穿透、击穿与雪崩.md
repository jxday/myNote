# 穿透、击穿与雪崩

>穿透：请求无效数据，造成缓存和数据库的全查。例如：对id进行缓存，查询id = -1的数据，就造成每次都会绕过缓存，全查数据库。
>
>击穿：对某一热点数据不断请求，当该热点数据缓存失效时，大量请求打到数据库上。
>
>雪崩：某些热点数据在同一时间失效，造成大量请求打到数据库上。

## 1.穿透

+ 如何解决：
    + 增加接口层校验：参数白名单、用户鉴权、参数校验、拒绝不合法参数。
        + 例如：分页查询接口没对分页参数的大小做限制。
    + 从缓存取不到的数据，在数据库中也没有取到，这时也可以将对应Key的Value对写为null、位置错误、稍后重试这样的值具体取啥问产品，或者看具体的场景，缓存有效时间可以设置短点，如30秒（设置太长会导致正常情况也没法使用）。
    + 防止攻击用户反复用同一个id暴力攻击，但是我们要知道正常用户是不会在单秒内发起这么多次请求的，那网关层Nginx本渣我也记得有配置项，可以让运维对单个IP每秒访问次数超出阈值的IP都拉黑。
    + Redis Bloom Filter防止缓存穿透。

## 2.击穿

+ 设置热点数据永远不过期。
+ 加上互斥锁



## 3.雪崩





## 4.总结

- 事前：Redis 高可用，主从+哨兵，Redis cluster，避免全盘崩溃。
- 事中：雪崩锁+本地 ehcache 缓存 + Hystrix 限流+降级，避免 DB 被打死。
- 事后：Redis 合理的持久化 RDB+AOF，一旦重启，自动从磁盘上加载数据，快速恢复缓存数据。

