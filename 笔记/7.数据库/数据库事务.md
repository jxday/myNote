### 数据库事务

> https://niceaz.com/2019/03/24/isolation-2pl-mvcc/#数据库隔离级别
>
> https://developer.aliyun.com/article/754205
>
> 依据冲突处理的时机（乐观程度），依次介绍了基于锁（在事务开始前预防冲突）、基于T/O（在事务执行中判断冲突）和基于Validation（在事务提交时验证冲突）的事务并发控制机制。不同的实现适用于不同的workload，并发冲突小的workload，当然适合更乐观的并发控制方式。而MVCC可以解决只读事务和读写事务之间相互阻塞的问题，提高了事务的并发读，被大多数主流数据库系统采用。
>
> 并发控制：2PL(S2PL),MVCC,Timing Order(T/O),Validation OCC

#### 1.原子性	atomicity

> 这一组操作要么一起生效，要么都不生效，事务执行过程中如遇错误，已经执行的操作要全部撤回，这就是事务的**原子性**。如果失败发生后，部分生效的事务无法撤回，那数据库就进入了不一致状态，与真实世界的事实相左。

#### 2.一致性	consistency

> 数据库反映的是真实世界，真实世界有很多限制，例如：账户之间无论怎么转账，总额不会变等现实约束；年龄不能为负值，性别最多只能有男、女、跨性别者三种选项等完整性约束。事务执行，不能打破这些约束，保证事务从一个正确的状态转移到另一个正确的状态，这就是**一致性**。不同与前三种性质完全由数据库实现保证，一致性既依赖于数据库实现（原子性、持久性、隔离性也是为了保证一致性），也依赖于应用端编写的事务逻辑。

#### 3.隔离性	isolation

> 数据库为了提高资源利用率和事务执行效率、降低响应时间，允许事务并发执行。但是多个事务同时操作同一对象，必然存在冲突，事务的中间状态可能暴露给其它事务，导致一些事务依据其它事务中间状态，把错误的值写到数据库里。需要提供一种机制，保证事务执行不受并发事务的影响，让用户感觉，当前仿佛只有自己发起的事务在执行，这就是**隔离性**。隔离性让用户可以专注于单个事务的逻辑，不用考虑并发执行的影响。数据库通过并发控制机制保证隔离性。由于隔离性对事务的执行顺序要求较高，很多数据库提供了不同选项，用户可以牺牲一部分隔离性，提升系统性能。这些不同的选项就是事务隔离级别。

#### 4.持久性	durability

> 事务只要提交了，它的结果就不能改变了，即使遇到系统宕机，重启后数据库的状态与宕机前一致，这就是事务的**持久性**。数据只要存储非易失存储介质，宕机就不会导致数据丢失。因此数据库可以采用以下方法来保证持久性：（1）事务完成前，所有的更改都保证存储到磁盘上了。或（2）提交完成前，事务的更改信息，以日志的形式存储在磁盘，重启过程根据日志恢复出数据库系统的内存状态。一般而言，数据库会选择方法（2）。





| 隔离级别 | 加锁算法                                               |
| -------- | ------------------------------------------------------ |
| RU       | 不需要 2PL，某次访问变量的时候加锁，访问完立即放锁即可 |
| RC       | 2PL + 级联终止 或者 S2PL                               |
| RR       | 2PL + 级联终止 / S2PL 天然满足RR                       |
| S        | 需要层级锁实现                                         |

| 隔离级别 | MVCC 算法                                                    |
| -------- | ------------------------------------------------------------ |
| RU       | 查找版本的时候，忽略版本的 IsCommited 属性                   |
| RC       | 查找版本的时候，多次读操作以每次读操作的时间戳为时间戳进行查找， 不忽略 IsCommited 属性，对数据更新的时候上 X 锁 |
| RR       | 查找版本的时候，多次读操作都以事务开始的时间戳为时间戳进行查找，不忽略 IsCommited 属性，事务开始的时候上 X 锁 |
| S        | 单纯的 MVCC 实现不了该级别，需要通过层级锁实现               |

 